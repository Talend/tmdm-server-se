<?xml version="1.0" encoding="UTF-8"?>
<!-- ======================================================================                                                   

     Xtentis MDM
     XML:DB Modules of Xtentis MDM - adapted for eXist Open
                   
     bgrieder                                                                
     ====================================================================== -->
<project name="XtentisMDM-Xmldb" xmlns:artifact="antlib:org.apache.maven.artifact.ant" default="all">
	<description>
            XML:DB module for Xtentis MDM
    </description>

    <property file="build.properties" />

    <target name="prepare-maven" if="local.developer.build">
        <path id="maven-ant-tasks.classpath" path="${maven.ant.tasks.file}" />
        <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="antlib:org.apache.maven.artifact.ant" classpathref="maven-ant-tasks.classpath" />
    </target>

	<property name="jar" value="z.mdm.xmldb.jar"/>

	<!--    DO NOT CHANGE ANYTHING BELOW THIS LINE   -->

	<property name="version.props" value="version.properties"/>

    <property name="build.dir" value="${basedir}/target" />
    <property name="jboss.dir" value="${jboss.dir}" />
    <property name="jboss.instance.dir" value="${jboss.dir}/server/default" />
    <property name="jboss.instance.lib" value="${jboss.instance.dir}/lib"/>
    <property name="jboss.deploy.dir" value="${jboss.instance.dir}/deploy" />


	<property name="tom.location" value="${basedir}/.." />

	<!-- ================================= 
          target: all              
         ================================= -->
	<target name="all" depends="clean,package,undeploy,deploy">
		<!--
			On newer eclipse versions - activate Refresh in the External Tools Configuration 
			<eclipse.refreshLocal resource="${basedir}"/> 
		-->
	</target>

    <target name="clean">
        <antcall target="mvn.invoke">
            <param name="mvn.goal" value="clean" />
        </antcall>
    </target>
    
    <target name="compile" depends="test">
        <antcall target="mvn.invoke">
            <param name="mvn.goal" value="compile" />
        </antcall>
        
        <antcall target="mvn.invoke">
            <param name="mvn.goal" value="test-compile" />
        </antcall>

        <copy todir="bin">
           <fileset dir="target/classes" includes="**" />
           <fileset dir="target/test-classes" includes="**" />
        </copy>
    </target>
    
    <target name="test">
        <antcall target="mvn.invoke">
            <param name="mvn.goal" value="test" />
        </antcall>
    </target>
	
	<target name="version"  description="Maintain build.date property">
		<buildnumber file="${version.props}" />
		<propertyfile file="${version.props}">
			<entry key="build.date" type="date" value="now" />
			<entry key="built.by" type="string" value="${user.name}" />
			<entry key="java.version" type="string" value="${java.vm.version}" />
		</propertyfile>
	</target>

	<target name="package" depends="version,compile">
		<property file="${version.props}" />
		<copy file="RELEASE.NOTES" tofile="RELEASE-${major}.${minor}.${rev}-${build.number}.NOTES" />
		<jar destfile="${jar}">
			<zipfileset dir=".">
				<include name="version.properties" />
			</zipfileset>
			<zipfileset dir=".">
				<include name="RELEASE.NOTES" />
			</zipfileset>
			<zipfileset dir="bin" includes="**/*.class" />
			<zipfileset dir="../org.talend.mdm.xmlserver.interfaces/bin" includes="**/interfaces/*.class" />
		</jar>
		<delete file="RELEASE-${major}.${minor}.${rev}-${build.number}.NOTES" />
	</target>

	<target name="undeploy" description="--> remove packages">
		<delete>
			<fileset dir="${jboss.instance.lib}" includes="${jar}"/>
		</delete>
	</target>

	<target name="deploy">
		<property file="${version.props}" />
		<echo>Deploying ${major}.${minor}.${rev}-${build.number}</echo>
		<copy file="${jar}" tofile="${jboss.instance.lib}/${jar}"/>
	</target>

    <target name="mvn.invoke" description="invokes maven" depends="prepare-maven">
        <property environment="env" />

        <artifact:mvn pom="pom.xml" mavenHome="${env.M2_HOME}" fork="true" failonerror="true">
            <arg value="-V" />
            <arg value="-Dmdm.build.dir=${build.dir}" />
            <arg value="-Dmdm.build.version=${mdm.build.version}" />
            <arg value="-Ddev.mode.excluded.start=${dev.mode.excluded.start}" />
            <arg value="-Ddev.mode.excluded.end=${dev.mode.excluded.end}" />
            <arg value="${mvn.goal}" />
        </artifact:mvn>
    </target>

</project>

